#**基于 Belief Propogation算法的增量式节点调度**
   + 出发点 
影响分布式系统性能的因素有很多，包括网络延迟、数据通信效能、计算节点处理能力、任务的分割、无法预算处理时间、任务的颠簸等等。而一个好的调度算法，可以有针对性的以解决这些问题为目的，从不同角度，不同侧面，利用一种或几种方法从而实现系统总体效率的相对最高。 
   + 现有框架 
通过分析rain的框架，发现目前的rain框架使用的是基于启发式算法的增量式调度。具体来说，rain只会在上次运行时间超过预设的阈值后调用调度器。阈值对于不同的状态，如有无更新，有无新的任务提交，会有所不同，并会基于上次调度所用时间适当增加阈值以减少调度次数。调度器对于整个图框架有完全的读取权限，并可以保存每个任务，控制器，消息传递，客户端及对象的元数据。当调用调度器时，会根据调度双方节点剩余cpu数和有效资源大小评分，最终从准备状态的控制器中选出最佳被分配任务控制器和分配任务控制器。在检查好任务是否准备后，将最佳被分配任务控制器的CPU全部分配任务，并释放源任务控制器的有效资源。
   + 改进思路
虽然目前的调度器性能不算差，但启发式算法在基于直观或经验构造一个在可接受的花费下的可行解，与最优解的偏离程度并不能被预计。此外，通过阅读其代码，我们发现他的调度算法需要每次两两一对分析转移任务的得分，时间复杂度至少为O(n^2)。通过小组成员的讨论以及查阅原作者的想法后，我们期望Belief Prpopagation（下称BP)的算法将其调度程序优化。由于BP算法运算复杂度只有O(n),所以可以实现在节点网络较大时的更加优秀的调度。 
   + 算法简介
BP算法是基于马尔科夫随机场的一种算法。所谓马尔科夫随机场，是一种特殊的贝叶斯网络，网络中的节点满足马尔科夫性质：某个节点的概率分布特性只与其领域内的点有关，与领域外的点无关。 马尔科夫随机场是一个无向图，其中的节点分为可观察节点（已知数据）yi和隐藏节点（未知量）xi，可观察节点与隐藏节点之间的相互作用因子用一个似然函数Φi(xi,yi)表示，两个相邻（有边连接）的隐藏节点之间的相互作用因子用势能量(xi,xj)表示。 
一个马尔科夫随机场中所有节点的联合概率分布函数为：$$p(x,y)=\prod_{(i,j)}ψ_ij_(x_i,x_j)\prod_{i}Φ_i(x_i,y_i)$$
在这种领域模型中，随机场中的每一个节点只与它直接相邻的节点有相互作用。对于其中的每一个节点，通过消息传播，把该节点的概率分布状态传递给相邻的节点，从而影响相邻节点的概率分布，可以证明，经过一定次数的迭代后，每个节点的概率分布将收敛于一个稳态。在BP算法中，定义了消息和置信度两个概念。 
消息更新规则： $m_ij(x_j)=\sum_{xi}Φ_i(x_i,y_i)ψ_ij_(x_i,x_j)\prod{k\inN(i)\setminusj}m_ki(x_i)$ 
置信度计算:    $b_i(x_i)=kΦ_i(x_i)\prod{j\inN(i)}m_ji(x_i)$ 
算法流程如下： 
1. 初始化所有隐藏节点的似然函数Φi(xi,yi)、每对邻居节点的势能量ψij(xi,xj)和消息mij(xj)，其中，似然函数和势函数的初始化与问题具体有关。
2. 随机找到某个点和它的邻居节点，用消息更新规则计算该节点发送给其邻居节点的所有消息，然后再随机找到某个节点，重复这个过程，当所有消息都更新一遍之后即完成一次迭代。 
3. 按照指定次数进行第二步的算法迭代，或判断消息是否收敛，若算法已经收敛，则开始计算每个节点的置信度。
4. 由置信度求出使得每个节点的边缘概率分布取得最大的变量。
   + 可行性分析
rain框架是基于图框架的。如果一个控制器的任务所需资源是其他一些控制器有效资源的子集，我们就可以视作分配任务控制器向其中有效资源最大的控制器发送一条信息，相当于连一条边。同样，我们也可以将这条信息根据剩余cpu数和有效资源数设置优先级。容易看出，这样的图模型是无环的，这样就可以保证BP算法的收敛性。因此，这种想法在理论上是可行的。








参考资料 1）置信度传播算法（Belief Propagation）https://blog.csdn.net/aspirinvagrant/article/details/40862237 
        

